<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bachelor Party Planner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 1.8em;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        input, select, button, textarea {
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.9em;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        tr:hover {
            background: #f8f9ff;
        }

        .action-btn {
            padding: 6px 12px;
            margin: 2px;
            font-size: 12px;
            border-radius: 5px;
        }

        .delete-btn {
            background: linear-gradient(135deg, #f56565 0%, #ed64a6 100%);
        }

        .venmo-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        }

        .calendar-btn {
            background: linear-gradient(135deg, #10b981 0%, #14b8a6 100%);
        }

        .edit-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #fb923c 100%);
        }

        .share-btn {
            background: linear-gradient(135deg, #ec4899 0%, #f43f5e 100%);
        }

        .venmo-link {
            color: #3b82f6;
            text-decoration: none;
            font-weight: 600;
            display: inline-block;
            padding: 5px 10px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .venmo-link:hover {
            background: rgba(59, 130, 246, 0.2);
            transform: translateX(5px);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            position: relative;
            background: white;
            margin: 50px auto;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .close {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 28px;
            font-weight: bold;
            color: #999;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #333;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }

        .payment-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-paid {
            background: #10b981;
            color: white;
        }

        .status-pending {
            background: #f59e0b;
            color: white;
        }

        .payment-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .share-link-container {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .share-link {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .share-link input {
            flex: 1;
            background: white;
        }

        .attendee-view {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .attendee-summary {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .amount-owed {
            font-size: 2em;
            font-weight: bold;
            color: #f59e0b;
            margin: 10px 0;
        }

        .read-only-notice {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            color: #92400e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .header p {
                font-size: 1em;
            }
            
            .content {
                padding: 15px;
            }
            
            .input-group {
                flex-direction: column;
            }
            
            input, select, button, textarea {
                width: 100%;
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            .stats {
                gap: 10px;
            }
            
            .stat-card {
                padding: 15px;
            }
            
            .stat-value {
                font-size: 1.5em;
            }
            
            table {
                font-size: 14px;
            }
            
            th, td {
                padding: 8px;
            }
            
            .action-btn {
                display: block;
                width: 100%;
                margin: 4px 0;
            }
            
            .venmo-link {
                display: block;
                text-align: center;
                margin: 4px 0;
            }
            
            .modal-content {
                width: 95%;
                margin: 20px auto;
                padding: 20px;
            }
            
            .payment-checkbox {
                width: 25px;
                height: 25px;
            }
            
            /* Stack table cells on very small screens */
            @media (max-width: 480px) {
                .table-container {
                    margin: 0 -15px;
                }
                
                table {
                    font-size: 12px;
                }
                
                th, td {
                    padding: 6px;
                    font-size: 12px;
                }
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéâ Bachelor Party Planner üçª</h1>
            <p id="headerSubtitle">Anthony Lisheron's Bachelor Party</p>
        </div>
        
        <div class="content" id="mainContent">
            <!-- Read-only notice (hidden by default) -->
            <div id="readOnlyNotice" class="read-only-notice" style="display: none;">
                üìã This is a read-only view. Contact the organizer to make changes.
            </div>

            <!-- Statistics -->
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalAttendees">0</div>
                    <div class="stat-label">Attendees</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalActivities">0</div>
                    <div class="stat-label">Activities</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalCost">$0</div>
                    <div class="stat-label">Total Cost</div>
                </div>
            </div>

            <!-- Admin-only sections -->
            <div id="adminSections">
                <!-- Sharing Section -->
                <div class="section">
                    <h2 class="section-title">üîó Sharing</h2>
                    <button onclick="generateShareLink()" class="share-btn">Generate Shareable Links</button>
                    <button onclick="previewAttendeeView()" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); margin-left: 10px;">Preview Attendee View</button>
                    <div id="shareLinkContainer" style="display: none;" class="share-link-container">
                        <p style="margin-bottom: 15px; font-weight: 600;">üìã Individual Attendee Links</p>
                        <p style="margin-bottom: 10px; color: #666;">Send each person their personalized link:</p>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${shareLinks.map(item => `
                                <div style="background: #f9fafb; padding: 10px; margin-bottom: 10px; border-radius: 8px;">
                                    <strong>${item.name}</strong>
                                    <div class="share-link" style="margin-top: 5px;">
                                        <input type="text" value="${item.link}" readonly style="font-size: 12px;">
                                        <button onclick="copyToClipboard('${item.link}')">Copy</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <hr style="margin: 20px 0; border: none; border-top: 1px solid #e5e7eb;">
                        <p style="margin-bottom: 10px; font-weight: 600;">üåê General Read-Only Link</p>
                        <p style="margin-bottom: 10px; color: #666;">For viewing all payment statuses:</p>
                        <div class="share-link">
                            <input type="text" id="shareLink" value="${baseURL}?view=readonly&data=${encodedData}" readonly>
                            <button onclick="copyShareLink()">Copy Link</button>
                        </div>
                    </div>
                </div>

                <!-- Venmo Settings -->
                <div class="section">
                    <h2 class="section-title">üí≥ Venmo Settings</h2>
                    <div class="input-group">
                        <input type="text" id="venmoUsername" placeholder="Your Venmo Username (e.g., @JohnDoe)" style="flex: 1;">
                        <button onclick="saveVenmoUsername()">Save Username</button>
                    </div>
                </div>

                <!-- Attendees Section -->
                <div class="section">
                    <h2 class="section-title">üë• Attendees</h2>
                    <div class="input-group">
                        <input type="text" id="attendeeName" placeholder="Name" style="flex: 1;">
                        <input type="email" id="attendeeEmail" placeholder="Email" style="flex: 1;">
                        <input type="tel" id="attendeePhone" placeholder="Phone" style="flex: 1;">
                        <button onclick="addAttendee()">Add Attendee</button>
                    </div>
                    <div class="table-container">
                        <table id="attendeesTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="attendeesBody">
                                <tr class="empty-state">
                                    <td colspan="4">No attendees added yet. Start by adding the crew!</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Activities Section -->
                <div class="section">
                    <h2 class="section-title">üéØ Activities</h2>
                    <div class="input-group">
                        <input type="text" id="activityName" placeholder="Activity Name" style="flex: 2;">
                        <input type="datetime-local" id="activityDate" style="flex: 1;">
                        <input type="text" id="activityLocation" placeholder="Location" style="flex: 2;">
                        <input type="number" id="activityCost" placeholder="Cost per person ($)" min="0" step="0.01" style="flex: 1;">
                        <input type="text" id="activityDescription" placeholder="Description" style="flex: 2;">
                        <button onclick="addActivity()">Add Activity</button>
                    </div>
                    <div class="table-container">
                        <table id="activitiesTable">
                            <thead>
                                <tr>
                                    <th>Activity</th>
                                    <th>Date & Time</th>
                                    <th>Location</th>
                                    <th>Cost/Person</th>
                                    <th>Description</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="activitiesBody">
                                <tr class="empty-state">
                                    <td colspan="6">No activities planned yet. Time to get creative!</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Payment Tracking Section -->
            <div class="section" id="paymentSection">
                <h2 class="section-title">üí∞ Payment Tracking</h2>
                <div id="paymentTrackingContainer">
                    <!-- Will be populated dynamically -->
                </div>
            </div>

            <!-- Attendee Personal View (hidden by default) -->
            <div id="attendeePersonalView" style="display: none;">
                <!-- Will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditModal()">&times;</span>
            <h2 style="margin-bottom: 20px; color: #667eea;">Edit Item</h2>
            <div id="editForm"></div>
        </div>
    </div>

    <script>
        let attendees = [];
        let activities = [];
        let payments = {}; // Structure: { attendeeIndex_activityIndex: true/false }
        let venmoUsername = '';
        let editingIndex = -1;
        let editingType = '';
        let isReadOnly = false;
        let viewingAttendee = null;

        // Check URL parameters
        function checkURLParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const view = urlParams.get('view');
            const attendeeId = urlParams.get('attendee');
            const dataParam = urlParams.get('data');
            
            if (view === 'readonly' && dataParam) {
                isReadOnly = true;
                try {
                    const decodedData = JSON.parse(atob(dataParam));
                    attendees = decodedData.attendees || [];
                    activities = decodedData.activities || [];
                    payments = decodedData.payments || {};
                    venmoUsername = decodedData.venmoUsername || '';
                    
                    if (attendeeId && attendeeId < attendees.length) {
                        viewingAttendee = parseInt(attendeeId);
                        setupReadOnlyView();
                    } else {
                        // Show attendee selector if no specific attendee is selected
                        setupAttendeeSelector();
                    }
                } catch (e) {
                    console.error('Error loading shared data:', e);
                }
            }
        }

        // Setup attendee selector view
        function setupAttendeeSelector() {
            document.getElementById('readOnlyNotice').style.display = 'none';
            document.getElementById('adminSections').style.display = 'none';
            document.getElementById('paymentSection').style.display = 'none';
            
            const mainContent = document.getElementById('mainContent');
            
            // Create selector interface
            const selectorHTML = `
                <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
                    <div style="background: white; border-radius: 15px; padding: 30px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);">
                        <h2 style="text-align: center; color: #667eea; margin-bottom: 10px;">Welcome to Anthony Lisheron's Bachelor Party! üéâ</h2>
                        <p style="text-align: center; color: #666; margin-bottom: 30px;">Select your name to view your payment status and event details</p>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">Who are you?</label>
                            <select id="attendeeSelector" style="width: 100%; padding: 15px; font-size: 16px; border: 2px solid #e0e0e0; border-radius: 10px; background: white;">
                                <option value="">-- Select Your Name --</option>
                                ${attendees.map((att, idx) => `<option value="${idx}">${att.name}</option>`).join('')}
                            </select>
                        </div>
                        
                        <button onclick="viewMyStatus()" style="width: 100%; padding: 15px; font-size: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">
                            View My Status
                        </button>
                        
                        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                            <h3 style="color: #333; margin-bottom: 15px;">üìÖ Event Overview</h3>
                            <div style="background: #f9fafb; padding: 15px; border-radius: 10px;">
                                <p style="margin-bottom: 10px;"><strong>Total Activities:</strong> ${activities.length}</p>
                                <p style="margin-bottom: 10px;"><strong>Total Attendees:</strong> ${attendees.length}</p>
                                <p><strong>Event Dates:</strong> ${getEventDateRange()}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Replace the main content with selector
            mainContent.innerHTML = selectorHTML;
            updateStats();
        }

        // Get event date range
        function getEventDateRange() {
            if (activities.length === 0) return 'No activities scheduled yet';
            
            const dates = activities.map(a => new Date(a.date)).sort((a, b) => a - b);
            const firstDate = dates[0].toLocaleDateString();
            const lastDate = dates[dates.length - 1].toLocaleDateString();
            
            if (firstDate === lastDate) {
                return firstDate;
            } else {
                return `${firstDate} - ${lastDate}`;
            }
        }

        // View selected attendee's status
        function viewMyStatus() {
            const selector = document.getElementById('attendeeSelector');
            const selectedIdx = selector.value;
            
            if (selectedIdx === '') {
                alert('Please select your name from the dropdown');
                return;
            }
            
            viewingAttendee = parseInt(selectedIdx);
            setupReadOnlyView();
        }

        // Setup read-only view
        function setupReadOnlyView() {
            document.getElementById('readOnlyNotice').style.display = 'block';
            document.getElementById('adminSections').style.display = 'none';
            
            if (viewingAttendee !== null) {
                // Add back button if coming from selector
                const backButton = `
                    <button onclick="backToSelector()" style="margin-bottom: 20px; background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);">
                        ‚Üê Back to Name Selection
                    </button>
                `;
                document.getElementById('readOnlyNotice').innerHTML = 
                    'üìã This is a read-only view. Contact the organizer to make changes.' + 
                    (viewingAttendee !== null ? `<br>${backButton}` : '');
                    
                document.getElementById('headerSubtitle').textContent = 
                    `Welcome, ${attendees[viewingAttendee].name}! Here's your payment status`;
                showAttendeePersonalView();
            }
            
            updateTables();
            updateStats();
        }

        // Back to selector
        function backToSelector() {
            viewingAttendee = null;
            setupAttendeeSelector();
        }

        // Show attendee personal view
        function showAttendeePersonalView() {
            if (viewingAttendee === null) return;
            
            const attendee = attendees[viewingAttendee];
            let totalOwed = 0;
            let paidActivities = [];
            let unpaidActivities = [];
            let freeActivities = [];
            
            activities.forEach((activity, actIdx) => {
                if (activity.cost > 0) {
                    const paymentKey = `${viewingAttendee}_${actIdx}`;
                    if (payments[paymentKey]) {
                        paidActivities.push(activity);
                    } else {
                        unpaidActivities.push(activity);
                        totalOwed += activity.cost;
                    }
                } else {
                    freeActivities.push(activity);
                }
            });
            
            const personalView = document.getElementById('attendeePersonalView');
            personalView.style.display = 'block';
            personalView.innerHTML = `
                <div class="attendee-summary">
                    <h2>Hi ${attendee.name}! üëã</h2>
                    <div class="amount-owed">Total Amount Owed: ${totalOwed.toFixed(2)}</div>
                    
                    ${unpaidActivities.length > 0 ? `
                        <h3 style="margin-top: 20px; margin-bottom: 15px; color: #f59e0b;">‚è≥ Pending Payments (${unpaidActivities.length})</h3>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            ${unpaidActivities.map((activity, idx) => {
                                const venmoLink = generateVenmoLink(activity.cost, `Bachelor Party - ${activity.name}`);
                                const activityDate = new Date(activity.date);
                                return `
                                    <div style="background: #fef3c7; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                                            <div>
                                                <strong>${activity.name}</strong><br>
                                                <small style="color: #666;">üìÖ ${activityDate.toLocaleDateString()} at ${activityDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</small><br>
                                                <small style="color: #666;">üìç ${activity.location || 'TBD'}</small>
                                                ${activity.description ? `<br><small style="color: #666;">‚ÑπÔ∏è ${activity.description}</small>` : ''}
                                            </div>
                                            <div style="text-align: right;">
                                                <div style="font-size: 1.2em; font-weight: bold; color: #92400e; margin-bottom: 5px;">${activity.cost.toFixed(2)}</div>
                                                <a href="${venmoLink}" target="_blank" class="venmo-link">üí≥ Pay Now</a>
                                                <button class="action-btn calendar-btn" onclick="generateICS(activities[${activities.indexOf(activity)}])" style="margin-top: 5px;">üìÖ Add to Calendar</button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    ` : ''}
                    
                    ${paidActivities.length > 0 ? `
                        <h3 style="margin-top: 20px; margin-bottom: 15px; color: #10b981;">‚úÖ Paid Activities (${paidActivities.length})</h3>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            ${paidActivities.map(activity => {
                                const activityDate = new Date(activity.date);
                                return `
                                    <div style="background: #d1fae5; padding: 15px; border-radius: 8px; border-left: 4px solid #10b981;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                                            <div>
                                                <strong>${activity.name}</strong><br>
                                                <small style="color: #666;">üìÖ ${activityDate.toLocaleDateString()} at ${activityDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</small><br>
                                                <small style="color: #666;">üìç ${activity.location || 'TBD'}</small>
                                            </div>
                                            <div style="text-align: right;">
                                                <span class="payment-status status-paid">PAID ‚úì</span>
                                                <button class="action-btn calendar-btn" onclick="generateICS(activities[${activities.indexOf(activity)}])" style="margin-top: 5px;">üìÖ Add to Calendar</button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    ` : ''}
                    
                    ${freeActivities.length > 0 ? `
                        <h3 style="margin-top: 20px; margin-bottom: 15px; color: #667eea;">üéâ Free Activities (${freeActivities.length})</h3>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            ${freeActivities.map(activity => {
                                const activityDate = new Date(activity.date);
                                return `
                                    <div style="background: #ede9fe; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                                            <div>
                                                <strong>${activity.name}</strong><br>
                                                <small style="color: #666;">üìÖ ${activityDate.toLocaleDateString()} at ${activityDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</small><br>
                                                <small style="color: #666;">üìç ${activity.location || 'TBD'}</small>
                                                ${activity.description ? `<br><small style="color: #666;">‚ÑπÔ∏è ${activity.description}</small>` : ''}
                                            </div>
                                            <div>
                                                <button class="action-btn calendar-btn" onclick="generateICS(activities[${activities.indexOf(activity)}])">üìÖ Add to Calendar</button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    ` : ''}
                    
                    ${unpaidActivities.length === 0 && paidActivities.length === 0 && freeActivities.length === 0 ? 
                        '<p style="text-align: center; color: #666; margin-top: 20px;">No activities scheduled yet!</p>' : ''}
                    
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                        <h3 style="margin-bottom: 15px; color: #333;">üìä Summary</h3>
                        <div style="background: #f9fafb; padding: 15px; border-radius: 8px;">
                            <p><strong>Total Owed:</strong> <span style="color: #f59e0b; font-weight: bold;">${totalOwed.toFixed(2)}</span></p>
                            <p><strong>Activities Paid:</strong> ${paidActivities.length} of ${paidActivities.length + unpaidActivities.length}</p>
                            <p><strong>Payment Method:</strong> Venmo to ${venmoUsername || 'TBD'}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Preview attendee view
        function previewAttendeeView() {
            if (attendees.length === 0) {
                alert('Please add at least one attendee first to preview their view.');
                return;
            }
            
            // Create a modal to select which attendee to preview
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <h2 style="margin-bottom: 20px; color: #667eea;">Preview Attendee View</h2>
                    <p style="margin-bottom: 15px;">Select an attendee to preview their personalized view:</p>
                    <select id="previewAttendeeSelect" style="width: 100%; margin-bottom: 20px;">
                        ${attendees.map((att, idx) => `<option value="${idx}">${att.name}</option>`).join('')}
                    </select>
                    <button onclick="showPreview()" style="width: 100%;">Show Preview</button>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Close modal when clicking outside
            modal.onclick = function(event) {
                if (event.target === modal) {
                    modal.remove();
                }
            };
        }
        
        // Show preview of selected attendee
        function showPreview() {
            const selectedIdx = parseInt(document.getElementById('previewAttendeeSelect').value);
            const attendee = attendees[selectedIdx];
            
            // Close the selection modal
            document.querySelector('.modal').remove();
            
            // Create preview modal
            const previewModal = document.createElement('div');
            previewModal.className = 'modal';
            previewModal.style.display = 'block';
            previewModal.innerHTML = `
                <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <h2 style="margin-bottom: 20px; color: #667eea;">Preview: ${attendee.name}'s View</h2>
                    <div style="border: 2px solid #e5e7eb; border-radius: 10px; padding: 20px; background: #f9fafb;">
                        ${generateAttendeeViewHTML(selectedIdx)}
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" style="width: 100%; margin-top: 20px;">Close Preview</button>
                </div>
            `;
            document.body.appendChild(previewModal);
            
            // Close modal when clicking outside
            previewModal.onclick = function(event) {
                if (event.target === previewModal) {
                    previewModal.remove();
                }
            };
        }
        
        // Generate attendee view HTML
        function generateAttendeeViewHTML(attendeeIdx) {
            const attendee = attendees[attendeeIdx];
            let totalOwed = 0;
            let paidActivities = [];
            let unpaidActivities = [];
            
            activities.forEach((activity, actIdx) => {
                if (activity.cost > 0) {
                    const paymentKey = `${attendeeIdx}_${actIdx}`;
                    if (payments[paymentKey]) {
                        paidActivities.push(activity);
                    } else {
                        unpaidActivities.push(activity);
                        totalOwed += activity.cost;
                    }
                }
            });
            
            return `
                <div style="background: #fef3c7; border: 2px solid #f59e0b; color: #92400e; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-weight: 600;">
                    üìã This is what ${attendee.name} will see (read-only view)
                </div>
                <div class="attendee-summary" style="background: white; padding: 20px; border-radius: 10px;">
                    <h2>Hi ${attendee.name}! üëã</h2>
                    <p style="color: #666; margin-top: 10px;">Welcome to Anthony Lisheron's Bachelor Party payment tracker</p>
                    <div class="amount-owed" style="font-size: 2em; font-weight: bold; color: #f59e0b; margin: 20px 0;">
                        Total Amount Owed: ${totalOwed.toFixed(2)}
                    </div>
                    
                    ${unpaidActivities.length > 0 ? `
                        <h3 style="margin-top: 20px; margin-bottom: 15px; color: #f59e0b;">‚è≥ Pending Payments (${unpaidActivities.length})</h3>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            ${unpaidActivities.map(activity => {
                                const venmoLink = generateVenmoLink(activity.cost, `Bachelor Party - ${activity.name}`);
                                return `
                                    <div style="background: #fef3c7; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                                            <div style="text-align: left;">
                                                <strong>${activity.name}</strong><br>
                                                <small style="color: #666;">${new Date(activity.date).toLocaleDateString()} - ${activity.location || 'TBD'}</small>
                                                ${activity.description ? `<br><small style="color: #666;">${activity.description}</small>` : ''}
                                            </div>
                                            <div style="text-align: right;">
                                                <div style="font-size: 1.2em; font-weight: bold; color: #92400e; margin-bottom: 5px;">${activity.cost.toFixed(2)}</div>
                                                <span class="venmo-link" style="background: #3b82f6; color: white; padding: 8px 12px; border-radius: 5px; display: inline-block;">üí≥ Pay via Venmo</span>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    ` : ''}
                    
                    ${paidActivities.length > 0 ? `
                        <h3 style="margin-top: 20px; margin-bottom: 15px; color: #10b981;">‚úÖ Paid Activities (${paidActivities.length})</h3>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            ${paidActivities.map(activity => `
                                <div style="background: #d1fae5; padding: 15px; border-radius: 8px; border-left: 4px solid #10b981;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="text-align: left;">
                                            <strong>${activity.name}</strong><br>
                                            <small style="color: #666;">${new Date(activity.date).toLocaleDateString()} - ${activity.location || 'TBD'}</small>
                                        </div>
                                        <div>
                                            <span style="background: #10b981; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">PAID ‚úì</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    ${unpaidActivities.length === 0 && paidActivities.length === 0 ? 
                        '<p style="text-align: center; color: #666; margin-top: 20px;">No activities with costs yet!</p>' : ''}
                    
                    ${activities.filter(a => a.cost === 0).length > 0 ? `
                        <h3 style="margin-top: 20px; margin-bottom: 15px; color: #667eea;">üìÖ Free Activities</h3>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            ${activities.filter(a => a.cost === 0).map(activity => `
                                <div style="background: #ede9fe; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                                    <strong>${activity.name}</strong><br>
                                    <small style="color: #666;">${new Date(activity.date).toLocaleDateString()} at ${new Date(activity.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</small><br>
                                    <small style="color: #666;">üìç ${activity.location || 'TBD'}</small>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Generate share link
        function generateShareLink() {
            // Get the correct base URL (works for both local and GitHub Pages)
            const baseURL = window.location.href.split('?')[0];
            
            const data = {
                attendees: attendees,
                activities: activities,
                payments: payments,
                venmoUsername: venmoUsername
            };
            const encodedData = btoa(JSON.stringify(data));
            
            // Generate the single universal link
            const universalLink = `${baseURL}?view=readonly&data=${encodedData}`;
            
            // Show the share links
            const container = document.getElementById('shareLinkContainer');
            container.style.display = 'block';
            container.innerHTML = `
                <p style="margin-bottom: 15px; font-weight: 600; color: #10b981;">‚úÖ Perfect for Group Texts!</p>
                <p style="margin-bottom: 10px; color: #666;">Send this ONE link to everyone. Each person selects their name to see their personalized view:</p>
                <div class="share-link" style="background: #f0fdf4; padding: 15px; border-radius: 8px; border: 2px solid #10b981;">
                    <input type="text" id="shareLink" value="${universalLink}" readonly style="font-size: 14px;">
                    <button onclick="copyShareLink()" style="background: linear-gradient(135deg, #10b981 0%, #14b8a6 100%);">Copy Link</button>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: #eff6ff; border-radius: 8px;">
                    <p style="margin-bottom: 10px; font-weight: 600;">üì± Sample Text Message:</p>
                    <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #cbd5e1; font-style: italic; color: #475569;">
                        "Hey everyone! üéâ Here's the link for Anthony's bachelor party details and payment tracking. Click the link, select your name, and you'll see what you owe plus all the event info: ${universalLink}"
                    </div>
                    <button onclick="copySampleText('${encodeURIComponent(universalLink)}')" style="margin-top: 10px; background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);">Copy Sample Text</button>
                </div>
                
                <details style="margin-top: 20px;">
                    <summary style="cursor: pointer; color: #667eea; font-weight: 600;">Optional: Individual Direct Links</summary>
                    <div style="margin-top: 15px; max-height: 300px; overflow-y: auto;">
                        ${attendees.map((attendee, index) => {
                            const individualLink = `${baseURL}?view=readonly&attendee=${index}&data=${encodedData}`;
                            return `
                                <div style="background: #f9fafb; padding: 10px; margin-bottom: 10px; border-radius: 8px;">
                                    <strong>${attendee.name}</strong>
                                    <div class="share-link" style="margin-top: 5px;">
                                        <input type="text" value="${individualLink}" readonly style="font-size: 12px;">
                                        <button onclick="copyToClipboard('${encodeURIComponent(individualLink)}')">Copy</button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </details>
            `;
        }
        
        // Copy sample text message
        function copySampleText(encodedLink) {
            const link = decodeURIComponent(encodedLink);
            const sampleText = `Hey everyone! üéâ Here's the link for Anthony's bachelor party details and payment tracking. Click the link, select your name, and you'll see what you owe plus all the event info: ${link}`;
            copyToClipboard(sampleText);
        }

        // Copy to clipboard
        function copyToClipboard(text) {
            // Decode if it was encoded
            if (text.includes('%')) {
                text = decodeURIComponent(text);
            }
            
            // Try modern clipboard API first
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    alert('Link copied to clipboard!');
                }).catch(() => {
                    fallbackCopyToClipboard(text);
                });
            } else {
                fallbackCopyToClipboard(text);
            }
        }
        
        // Fallback copy method for older browsers
        function fallbackCopyToClipboard(text) {
            const tempInput = document.createElement('textarea');
            tempInput.value = text;
            tempInput.style.position = 'fixed';
            tempInput.style.opacity = '0';
            document.body.appendChild(tempInput);
            tempInput.select();
            tempInput.setSelectionRange(0, 99999); // For mobile devices
            
            try {
                document.execCommand('copy');
                alert('Link copied to clipboard!');
            } catch (err) {
                alert('Failed to copy. Please select and copy the link manually.');
            }
            
            document.body.removeChild(tempInput);
        }

        // Copy share link
        function copyShareLink() {
            const shareLink = document.getElementById('shareLink');
            shareLink.select();
            document.execCommand('copy');
            alert('Link copied to clipboard!');
        }

        // Load data from localStorage
        function loadData() {
            if (isReadOnly) return; // Don't load from localStorage if in read-only mode
            
            const savedAttendees = localStorage.getItem('bachelorPartyAttendees');
            const savedActivities = localStorage.getItem('bachelorPartyActivities');
            const savedPayments = localStorage.getItem('bachelorPartyPayments');
            const savedVenmo = localStorage.getItem('bachelorPartyVenmo');
            
            if (savedAttendees) attendees = JSON.parse(savedAttendees);
            if (savedActivities) activities = JSON.parse(savedActivities);
            if (savedPayments) payments = JSON.parse(savedPayments);
            if (savedVenmo) {
                venmoUsername = savedVenmo;
                document.getElementById('venmoUsername').value = venmoUsername;
            }
            
            updateTables();
            updateStats();
        }

        // Save data to localStorage
        function saveData() {
            if (isReadOnly) return; // Don't save if in read-only mode
            
            localStorage.setItem('bachelorPartyAttendees', JSON.stringify(attendees));
            localStorage.setItem('bachelorPartyActivities', JSON.stringify(activities));
            localStorage.setItem('bachelorPartyPayments', JSON.stringify(payments));
            updateStats();
        }

        // Toggle payment status
        function togglePayment(attendeeIdx, activityIdx) {
            if (isReadOnly) return;
            
            const key = `${attendeeIdx}_${activityIdx}`;
            payments[key] = !payments[key];
            saveData();
            updatePaymentTracking();
            updateStats();
        }

        // Update payment tracking table
        function updatePaymentTracking() {
            const container = document.getElementById('paymentTrackingContainer');
            
            if (activities.filter(a => a.cost > 0).length === 0 || attendees.length === 0) {
                container.innerHTML = '<p class="empty-state">Add attendees and activities with costs to track payments</p>';
                return;
            }
            
            let html = '<div class="table-container"><table><thead><tr><th>Attendee</th>';
            
            // Add column headers for each activity with cost
            activities.forEach((activity, idx) => {
                if (activity.cost > 0) {
                    html += `<th>${activity.name}<br><small>$${activity.cost.toFixed(2)}</small></th>`;
                }
            });
            
            html += '<th>Total Owed</th>';
            if (!isReadOnly) {
                html += '<th>Send Reminder</th>';
            }
            html += '</tr></thead><tbody>';
            
            // Add rows for each attendee
            attendees.forEach((attendee, attIdx) => {
                let totalOwed = 0;
                html += `<tr><td><strong>${attendee.name}</strong></td>`;
                
                activities.forEach((activity, actIdx) => {
                    if (activity.cost > 0) {
                        const key = `${attIdx}_${actIdx}`;
                        const isPaid = payments[key];
                        
                        if (!isPaid) {
                            totalOwed += activity.cost;
                        }
                        
                        if (isReadOnly) {
                            html += `<td style="text-align: center;">
                                ${isPaid ? 
                                    '<span class="payment-status status-paid">PAID</span>' : 
                                    '<span class="payment-status status-pending">PENDING</span>'}
                            </td>`;
                        } else {
                            html += `<td style="text-align: center;">
                                <input type="checkbox" 
                                    class="payment-checkbox" 
                                    ${isPaid ? 'checked' : ''} 
                                    onchange="togglePayment(${attIdx}, ${actIdx})"
                                    title="${isPaid ? 'Mark as unpaid' : 'Mark as paid'}">
                                <br>
                                <small>${isPaid ? '‚úÖ Paid' : '‚è≥ Pending'}</small>
                            </td>`;
                        }
                    }
                });
                
                html += `<td style="text-align: center; font-weight: bold; color: ${totalOwed > 0 ? '#f59e0b' : '#10b981'};">
                    $${totalOwed.toFixed(2)}
                </td>`;
                
                if (!isReadOnly && totalOwed > 0) {
                    const reminderLink = generateReminderLink(attendee, totalOwed);
                    html += `<td><a href="${reminderLink}" class="action-btn venmo-btn" style="text-decoration: none;">üìß Email</a></td>`;
                } else if (!isReadOnly) {
                    html += '<td>-</td>';
                }
                
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // Generate reminder email link
        function generateReminderLink(attendee, totalOwed) {
            const subject = encodeURIComponent('Bachelor Party Payment Reminder');
            const unpaidActivities = [];
            
            activities.forEach((activity, actIdx) => {
                if (activity.cost > 0) {
                    const key = `${attendees.indexOf(attendee)}_${actIdx}`;
                    if (!payments[key]) {
                        unpaidActivities.push(`- ${activity.name}: ${activity.cost.toFixed(2)}`);
                    }
                }
            });
            
            const body = encodeURIComponent(
                `Hi ${attendee.name},\n\n` +
                `Just a friendly reminder about your pending payments for the bachelor party:\n\n` +
                `${unpaidActivities.join('\n')}\n\n` +
                `Total Amount Due: ${totalOwed.toFixed(2)}\n\n` +
                `You can pay via Venmo to ${venmoUsername || '[Venmo username not set]'}\n\n` +
                `Thanks!\n`
            );
            
            return `mailto:${attendee.email}?subject=${subject}&body=${body}`;
