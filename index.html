<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anthony's Bachelor Party</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .sync-status {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .sync-connected {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .sync-disconnected {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .sync-saving {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 1.8em;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        input, button, label, textarea {
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        label {
            background: #f9fafb;
            border: none;
            font-weight: 600;
            color: #374151;
            display: flex;
            align-items: center;
            white-space: nowrap;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .github-setup {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .setup-step {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .action-btn {
            padding: 6px 12px;
            margin: 2px;
            font-size: 12px;
            border-radius: 5px;
            border: none;
            color: white;
            cursor: pointer;
        }

        .delete-btn { background: #ef4444; }
        .edit-btn { background: #f59e0b; }
        .share-btn { background: #ec4899; }
        .github-btn { background: #24292e; }

        .payment-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }

        .share-container {
            background: #f0fdf4;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border: 2px solid #10b981;
        }

        .share-link {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 10px 0;
        }

        .share-link input {
            flex: 1;
            background: white;
        }

        /* Attendee View Styles */
        .attendee-selector {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .attendee-summary {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .amount-owed {
            font-size: 2em;
            font-weight: bold;
            color: #f59e0b;
            margin: 10px 0;
        }

        .activity-card {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid;
        }

        .pending { background: #fef3c7; border-color: #f59e0b; }
        .paid { background: #d1fae5; border-color: #10b981; }
        .free { background: #ede9fe; border-color: #667eea; }

        .venmo-link {
            background: #3b82f6;
            color: white;
            padding: 8px 16px;
            border-radius: 5px;
            text-decoration: none;
            display: inline-block;
            margin: 5px 0;
        }

        .calendar-btn {
            background: #10b981;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .content { padding: 15px; }
            .input-group, .input-row { flex-direction: column; }
            input, button { width: 100%; font-size: 16px; }
            .sync-status { position: static; margin-bottom: 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div id="syncStatus" class="sync-status sync-disconnected">üîÑ Not Connected</div>
            <h1>üéâ Anthony's Bachelor Party üçª</h1>
            <p id="headerSubtitle">Event Management & Payment Tracking</p>
        </div>
        
        <div class="content" id="mainContent">
            <!-- GitHub Setup (hidden after setup) -->
            <div id="githubSetup" class="github-setup">
                <h2 style="color: #24292e; margin-bottom: 20px;">üîß One-Time GitHub Setup</h2>
                <p style="margin-bottom: 20px;">To sync your data across all devices, we'll use GitHub Gists. This is free and keeps your data secure in your GitHub account.</p>
                
                <div class="setup-step">
                    <h3>Step 1: Create GitHub Personal Access Token</h3>
                    <p>1. Go to <a href="https://github.com/settings/tokens" target="_blank">GitHub Settings ‚Üí Personal Access Tokens ‚Üí Tokens (classic)</a></p>
                    <p>2. Click "Generate new token (classic)"</p>
                    <p>3. Give it a name like "Bachelor Party App"</p>
                    <p>4. Check ONLY the "gist" permission</p>
                    <p>5. Click "Generate token" and copy it</p>
                </div>
                
                <div class="setup-step">
                    <h3>Step 2: Enter Your Token</h3>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <input type="password" id="githubToken" placeholder="Paste your GitHub token here" style="flex: 1;">
                        <button onclick="setupGitHub()" class="github-btn">Connect GitHub</button>
                    </div>
                    <p style="margin-top: 10px; font-size: 12px; color: #666;">Your token is stored securely in your browser only.</p>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="skipGitHub()" style="background: #6b7280;">Skip for Now (Local Storage Only)</button>
                </div>
            </div>

            <!-- Statistics -->
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalAttendees">0</div>
                    <div class="stat-label">Attendees</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalActivities">0</div>
                    <div class="stat-label">Activities</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalCost">$0</div>
                    <div class="stat-label">Total Cost</div>
                </div>
            </div>

            <!-- Admin sections -->
            <div id="adminSections">
                <!-- GitHub Status Section -->
                <div class="section" id="githubStatusSection" style="display: none;">
                    <h2 class="section-title">üîÑ Sync Status</h2>
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                        <span id="lastSyncTime" style="color: #666;">Never synced</span>
                        <button onclick="forcSync()" style="padding: 8px 12px; font-size: 12px;">Force Sync</button>
                        <button onclick="resetGitHub()" style="padding: 8px 12px; font-size: 12px; background: #ef4444;">Disconnect</button>
                    </div>
                </div>

                <!-- Share Link Section -->
                <div class="section">
                    <h2 class="section-title">üîó Share with Everyone</h2>
                    <button onclick="generateShareLink()" class="share-btn">Generate Share Link</button>
                    <div id="shareContainer" style="display: none;"></div>
                </div>

                <!-- Attendees Section -->
                <div class="section">
                    <h2 class="section-title">üë• Attendees</h2>
                    <div class="input-group">
                        <input type="text" id="attendeeName" placeholder="Name" style="flex: 1;">
                        <button onclick="addAttendee()">Add Attendee</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr><th>Name</th><th>Actions</th></tr>
                            </thead>
                            <tbody id="attendeesBody">
                                <tr class="empty-state">
                                    <td colspan="2">No attendees added yet</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Activities Section -->
                <div class="section">
                    <h2 class="section-title">üéØ Activities</h2>
                    <div class="input-row">
                        <input type="text" id="activityName" placeholder="Activity Name" style="flex: 2;">
                        <input type="text" id="activityLocation" placeholder="Location" style="flex: 1;">
                        <input type="number" id="activityCost" placeholder="Cost per person ($)" min="0" step="0.01" style="flex: 1;">
                    </div>
                    <div class="input-row">
                        <label>Start:</label>
                        <input type="datetime-local" id="activityStartDate" style="flex: 1;">
                        <label>End:</label>
                        <input type="datetime-local" id="activityEndDate" style="flex: 1;">
                        <button onclick="addActivity()">Add Activity</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Activity</th>
                                    <th>Start Date & Time</th>
                                    <th>End Date & Time</th>
                                    <th>Location</th>
                                    <th>Cost/Person</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="activitiesBody">
                                <tr class="empty-state">
                                    <td colspan="6">No activities planned yet</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Payment Tracking Section -->
            <div class="section">
                <h2 class="section-title">üí∞ Payment Tracking</h2>
                <div id="paymentContainer"></div>
            </div>
        </div>
    </div>

    <script>
        let attendees = [];
        let activities = [];
        let payments = {};
        const venmoUsername = 'alisheron';
        let isReadOnly = false;
        let viewingAttendee = null;
        
        // GitHub integration
        let githubToken = '';
        let gistId = '';
        let isGitHubConnected = false;
        let lastSyncTime = null;

        // Initialize
        window.onload = function() {
            checkURLParams();
            if (!isReadOnly) {
                loadGitHubSettings();
                if (isGitHubConnected) {
                    loadFromGitHub();
                } else {
                    loadLocalData();
                }
            }
        };

        function checkURLParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const view = urlParams.get('view');
            const gistParam = urlParams.get('gist');
            
            if (view === 'readonly' && gistParam) {
                // Load from specific gist for read-only view
                isReadOnly = true;
                loadFromSpecificGist(gistParam);
            } else if (view === 'readonly') {
                // Fallback to old data parameter method
                const dataParam = urlParams.get('data');
                if (dataParam) {
                    isReadOnly = true;
                    try {
                        const decodedData = JSON.parse(atob(dataParam));
                        attendees = decodedData.attendees || [];
                        activities = decodedData.activities || [];
                        payments = decodedData.payments || {};
                        setupAttendeeView();
                    } catch (e) {
                        console.error('Error loading data:', e);
                    }
                }
            }
        }

        async function loadFromSpecificGist(gistId) {
            try {
                updateSyncStatus('loading', 'Loading...');
                const response = await fetch(`https://api.github.com/gists/${gistId}`);
                
                if (response.ok) {
                    const gist = await response.json();
                    const content = gist.files['bachelor-party-data.json'].content;
                    const data = JSON.parse(content);
                    
                    attendees = data.attendees || [];
                    activities = data.activities || [];
                    payments = data.payments || {};
                    
                    setupAttendeeView();
                } else {
                    console.error('Failed to load gist:', response.statusText);
                    setupAttendeeView(); // Show empty view
                }
            } catch (error) {
                console.error('Error loading from gist:', error);
                setupAttendeeView(); // Show empty view
            }
        }

        function loadGitHubSettings() {
            githubToken = localStorage.getItem('githubToken') || '';
            gistId = localStorage.getItem('gistId') || '';
            isGitHubConnected = githubToken && gistId;
            lastSyncTime = localStorage.getItem('lastSyncTime');

            if (isGitHubConnected) {
                document.getElementById('githubSetup').style.display = 'none';
                document.getElementById('githubStatusSection').style.display = 'block';
                updateSyncStatus('connected', '‚úÖ Connected to GitHub');
                updateLastSyncDisplay();
            } else {
                updateSyncStatus('disconnected', 'üîÑ Not Connected');
            }
        }

        async function setupGitHub() {
            const token = document.getElementById('githubToken').value.trim();
            if (!token) {
                alert('Please enter your GitHub token');
                return;
            }

            try {
                updateSyncStatus('loading', 'Connecting...');
                
                // Test the token by trying to list gists
                const testResponse = await fetch('https://api.github.com/gists', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!testResponse.ok) {
                    throw new Error('Invalid token or insufficient permissions');
                }

                // Create initial gist with current data
                const initialData = {
                    attendees: attendees,
                    activities: activities,
                    payments: payments,
                    lastUpdated: new Date().toISOString()
                };

                const createGistResponse = await fetch('https://api.github.com/gists', {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        description: 'Anthony\'s Bachelor Party Data',
                        public: false,
                        files: {
                            'bachelor-party-data.json': {
                                content: JSON.stringify(initialData, null, 2)
                            }
                        }
                    })
                });

                if (!createGistResponse.ok) {
                    throw new Error('Failed to create gist');
                }

                const gist = await createGistResponse.json();
                
                // Save settings
                githubToken = token;
                gistId = gist.id;
                isGitHubConnected = true;
                lastSyncTime = new Date().toISOString();

                localStorage.setItem('githubToken', githubToken);
                localStorage.setItem('gistId', gistId);
                localStorage.setItem('lastSyncTime', lastSyncTime);

                // Update UI
                document.getElementById('githubSetup').style.display = 'none';
                document.getElementById('githubStatusSection').style.display = 'block';
                updateSyncStatus('connected', '‚úÖ Connected to GitHub');
                updateLastSyncDisplay();

                alert('Successfully connected to GitHub! Your data will now sync across all devices.');

            } catch (error) {
                console.error('GitHub setup error:', error);
                updateSyncStatus('disconnected', '‚ùå Connection Failed');
                alert('Failed to connect to GitHub: ' + error.message);
            }
        }

        function skipGitHub() {
            document.getElementById('githubSetup').style.display = 'none';
            loadLocalData();
        }

        function resetGitHub() {
            if (confirm('This will disconnect GitHub sync and use local storage only. Continue?')) {
                localStorage.removeItem('githubToken');
                localStorage.removeItem('gistId');
                localStorage.removeItem('lastSyncTime');
                
                githubToken = '';
                gistId = '';
                isGitHubConnected = false;
                lastSyncTime = null;

                document.getElementById('githubSetup').style.display = 'block';
                document.getElementById('githubStatusSection').style.display = 'none';
                updateSyncStatus('disconnected', 'üîÑ Not Connected');
            }
        }

        async function saveToGitHub() {
            if (!isGitHubConnected) return;

            try {
                updateSyncStatus('saving', 'üíæ Saving...');

                const data = {
                    attendees: attendees,
                    activities: activities,
                    payments: payments,
                    lastUpdated: new Date().toISOString()
                };

                const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        files: {
                            'bachelor-party-data.json': {
                                content: JSON.stringify(data, null, 2)
                            }
                        }
                    })
                });

                if (response.ok) {
                    lastSyncTime = new Date().toISOString();
                    localStorage.setItem('lastSyncTime', lastSyncTime);
                    updateSyncStatus('connected', '‚úÖ Synced');
                    updateLastSyncDisplay();
                } else {
                    throw new Error('Failed to save to GitHub');
                }

            } catch (error) {
                console.error('Error saving to GitHub:', error);
                updateSyncStatus('connected', '‚ö†Ô∏è Sync Error');
            }
        }

        async function loadFromGitHub() {
            if (!isGitHubConnected) return;

            try {
                updateSyncStatus('loading', 'Loading...');

                const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (response.ok) {
                    const gist = await response.json();
                    const content = gist.files['bachelor-party-data.json'].content;
                    const data = JSON.parse(content);

                    attendees = data.attendees || [];
                    activities = data.activities || [];
                    payments = data.payments || {};

                    updateTables();
                    updateSyncStatus('connected', '‚úÖ Connected');
                } else {
                    throw new Error('Failed to load from GitHub');
                }

            } catch (error) {
                console.error('Error loading from GitHub:', error);
                updateSyncStatus('connected', '‚ö†Ô∏è Load Error');
                loadLocalData(); // Fallback to local data
            }
        }

        function forcSync() {
            if (isGitHubConnected) {
                loadFromGitHub();
            }
        }

        function updateSyncStatus(status, text) {
            const statusEl = document.getElementById('syncStatus');
            statusEl.className = `sync-status sync-${status}`;
            statusEl.textContent = text;
        }

        function updateLastSyncDisplay() {
            if (lastSyncTime) {
                const date = new Date(lastSyncTime);
                document.getElementById('lastSyncTime').textContent = 
                    `Last synced: ${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
            }
        }

        function setupAttendeeView() {
            document.getElementById('adminSections').style.display = 'none';
            
            const mainContent = document.getElementById('mainContent');
            
            // Keep the stats, but replace the admin content
            const statsHtml = document.querySelector('.stats').outerHTML;
            
            mainContent.innerHTML = `
                ${statsHtml}
                <div class="attendee-selector">
                    <h2 style="text-align: center; color: #667eea; margin-bottom: 10px;">Welcome to Anthony's Bachelor Party! üéâ</h2>
                    <p style="text-align: center; color: #666; margin-bottom: 30px;">Select your name to view your payment status and event details</p>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600; padding: 0; background: none; border: none;">Who are you?</label>
                        <select id="attendeeSelector" style="width: 100%; padding: 15px; font-size: 16px; border: 2px solid #e0e0e0; border-radius: 10px;">
                            <option value="">-- Select Your Name --</option>
                            ${attendees.map((att, idx) => `<option value="${idx}">${att.name}</option>`).join('')}
                        </select>
                    </div>
                    
                    <button onclick="viewMyStatus()" style="width: 100%; padding: 15px; font-size: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">
                        View My Status
                    </button>
                    
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                        <h3 style="color: #333; margin-bottom: 15px;">üìÖ Event Overview</h3>
                        <div style="background: #f9fafb; padding: 15px; border-radius: 10px;">
                            <p><strong>Total Activities:</strong> ${activities.length}</p>
                            <p><strong>Total Attendees:</strong> ${attendees.length}</p>
                            <p><strong>Total Cost:</strong> $${activities.reduce((sum, activity) => sum + activity.cost, 0).toFixed(2)}</p>
                        </div>
                    </div>
                </div>
                <div id="personalView" style="display: none;"></div>
            `;
            updateStats();
        }

        function viewMyStatus() {
            const selector = document.getElementById('attendeeSelector');
            const selectedIdx = selector.value;
            
            if (selectedIdx === '') {
                alert('Please select your name');
                return;
            }
            
            viewingAttendee = parseInt(selectedIdx);
            showPersonalView();
        }

        function showPersonalView() {
            document.querySelector('.attendee-selector').style.display = 'none';
            const personalView = document.getElementById('personalView');
            personalView.style.display = 'block';
            
            const attendee = attendees[viewingAttendee];
            let totalOwed = 0;
            let paidCount = 0;
            let unpaidActivities = [];
            let paidActivities = [];
            let freeActivities = [];
            
            activities.forEach((activity, actIdx) => {
                if (activity.cost > 0) {
                    const paymentKey = `${viewingAttendee}_${actIdx}`;
                    if (payments[paymentKey]) {
                        paidActivities.push(activity);
                        paidCount++;
                    } else {
                        unpaidActivities.push(activity);
                        totalOwed += activity.cost;
                    }
                } else {
                    freeActivities.push(activity);
                }
            });
            
            personalView.innerHTML = `
                <button onclick="backToSelector()" style="margin-bottom: 20px; background: #6b7280;">‚Üê Back to Name Selection</button>
                
                <div class="attendee-summary">
                    <h2>Hi ${attendee.name}! üëã</h2>
                    <div class="amount-owed">Total Owed: $${totalOwed.toFixed(2)}</div>
                    
                    ${unpaidActivities.length > 0 ? `
                        <h3 style="color: #f59e0b; margin: 20px 0 15px;">‚è≥ Pending Payments (${unpaidActivities.length})</h3>
                        ${unpaidActivities.map(activity => {
                            const venmoLink = `https://venmo.com/${venmoUsername}?txn=pay&amount=${activity.cost}&note=${encodeURIComponent('Bachelor Party - ' + activity.name)}`;
                            const startDate = new Date(activity.startDate);
                            const endDate = new Date(activity.endDate);
                            const duration = activity.endDate ? ` - ${endDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}` : '';
                            
                            return `
                                <div class="activity-card pending">
                                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                                        <div>
                                            <strong>${activity.name}</strong><br>
                                            <small>üìÖ ${startDate.toLocaleDateString()} at ${startDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}${duration}</small><br>
                                            <small>üìç ${activity.location || 'TBD'}</small>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 5px;">$${activity.cost.toFixed(2)}</div>
                                            <a href="${venmoLink}" target="_blank" class="venmo-link">üí≥ Pay Now</a>
                                            <button class="calendar-btn" onclick="downloadCalendar(${activities.indexOf(activity)})">üìÖ Calendar</button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    ` : ''}
                    
                    ${paidActivities.length > 0 ? `
                        <h3 style="color: #10b981; margin: 20px 0 15px;">‚úÖ Paid Activities (${paidActivities.length})</h3>
                        ${paidActivities.map(activity => {
                            const startDate = new Date(activity.startDate);
                            const endDate = new Date(activity.endDate);
                            const duration = activity.endDate ? ` - ${endDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}` : '';
                            
                            return `
                                <div class="activity-card paid">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <strong>${activity.name}</strong><br>
                                            <small>üìÖ ${startDate.toLocaleDateString()} at ${startDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}${duration}</small><br>
                                            <small>üìç ${activity.location || 'TBD'}</small>
                                        </div>
                                        <div>
                                            <span style="background: #10b981; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">PAID ‚úì</span>
                                            <button class="calendar-btn" onclick="downloadCalendar(${activities.indexOf(activity)})">üìÖ Calendar</button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    ` : ''}
                    
                    ${freeActivities.length > 0 ? `
                        <h3 style="color: #667eea; margin: 20px 0 15px;">üéâ Free Activities (${freeActivities.length})</h3>
                        ${freeActivities.map(activity => {
                            const startDate = new Date(activity.startDate);
                            const endDate = new Date(activity.endDate);
                            const duration = activity.endDate ? ` - ${endDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}` : '';
                            
                            return `
                                <div class="activity-card free">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <strong>${activity.name}</strong><br>
                                            <small>üìÖ ${startDate.toLocaleDateString()} at ${startDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}${duration}</small><br>
                                            <small>üìç ${activity.location || 'TBD'}</small>
                                        </div>
                                        <button class="calendar-btn" onclick="downloadCalendar(${activities.indexOf(activity)})">üìÖ Calendar</button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    ` : ''}
                    
                    <div style="margin-top: 30px; padding: 15px; background: #f9fafb; border-radius: 8px;">
                        <h3>üìä Summary</h3>
                        <p><strong>Total Owed:</strong> $${totalOwed.toFixed(2)}</p>
                        <p><strong>Activities Paid:</strong> ${paidCount} of ${paidActivities.length + unpaidActivities.length}</p>
                        <p><strong>Payment:</strong> Venmo @${venmoUsername}</p>
                    </div>
                </div>
            `;
        }

        function backToSelector() {
            document.querySelector('.attendee-selector').style.display = 'block';
            document.getElementById('personalView').style.display = 'none';
        }

        function downloadCalendar(activityIndex) {
            const activity = activities[activityIndex];
            const startDate = new Date(activity.startDate);
            const endDate = activity.endDate ? new Date(activity.endDate) : new Date(startDate.getTime() + 2 * 60 * 60 * 1000);
            
            const formatDate = (date) => {
                return date.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
            };
            
            const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Bachelor Party//EN
BEGIN:VEVENT
UID:${Date.now()}@bachelorparty.com
DTSTAMP:${formatDate(new Date())}
DTSTART:${formatDate(startDate)}
DTEND:${formatDate(endDate)}
SUMMARY:${activity.name}
DESCRIPTION:Anthony's Bachelor Party - ${activity.name}
LOCATION:${activity.location || 'TBD'}
END:VEVENT
END:VCALENDAR`;

            const blob = new Blob([icsContent], { type: 'text/calendar' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${activity.name}.ics`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Admin functions
        function addAttendee() {
            const name = document.getElementById('attendeeName').value.trim();
            if (!name) {
                alert('Please enter a name');
                return;
            }
            
            attendees.push({ name });
            document.getElementById('attendeeName').value = '';
            saveData();
            updateTables();
        }

        function addActivity() {
            const name = document.getElementById('activityName').value.trim();
            const startDate = document.getElementById('activityStartDate').value;
            const endDate = document.getElementById('activityEndDate').value;
            const location = document.getElementById('activityLocation').value.trim();
            const cost = parseFloat(document.getElementById('activityCost').value) || 0;
            
            if (!name) {
                alert('Please enter an activity name');
                return;
            }
            
            if (!startDate) {
                alert('Please enter a start date and time');
                return;
            }
            
            activities.push({ name, startDate, endDate, location, cost });
            
            // Clear inputs
            document.getElementById('activityName').value = '';
            document.getElementById('activityStartDate').value = '';
            document.getElementById('activityEndDate').value = '';
            document.getElementById('activityLocation').value = '';
            document.getElementById('activityCost').value = '';
            
            saveData();
            updateTables();
        }

        function deleteAttendee(index) {
            if (confirm('Delete this attendee?')) {
                attendees.splice(index, 1);
                // Clean up payments
                Object.keys(payments).forEach(key => {
                    const [attendeeIdx] = key.split('_').map(Number);
                    if (attendeeIdx === index) {
                        delete payments[key];
                    } else if (attendeeIdx > index) {
                        const [, activityIdx] = key.split('_').map(Number);
                        delete payments[key];
                        payments[`${attendeeIdx - 1}_${activityIdx}`] = payments[key];
                    }
                });
                saveData();
                updateTables();
            }
        }

        function deleteActivity(index) {
            if (confirm('Delete this activity?')) {
                activities.splice(index, 1);
                // Clean up payments
                Object.keys(payments).forEach(key => {
                    const [attendeeIdx, activityIdx] = key.split('_').map(Number);
                    if (activityIdx === index) {
                        delete payments[key];
                    } else if (activityIdx > index) {
                        delete payments[key];
                        payments[`${attendeeIdx}_${activityIdx - 1}`] = payments[key];
                    }
                });
                saveData();
                updateTables();
            }
        }

        function togglePayment(attendeeIdx, activityIdx) {
            const key = `${attendeeIdx}_${activityIdx}`;
            payments[key] = !payments[key];
            saveData();
            updatePaymentTracking();
        }

        function generateShareLink() {
            if (attendees.length === 0) {
                alert('Please add at least one attendee first');
                return;
            }
            
            const baseURL = window.location.href.split('?')[0];
            let shareLink;
            
            if (isGitHubConnected) {
                // Use gist-based sharing for real-time updates
                shareLink = `${baseURL}?view=readonly&gist=${gistId}`;
            } else {
                // Fallback to data parameter method
                const data = { attendees, activities, payments };
                const encodedData = btoa(JSON.stringify(data));
                shareLink = `${baseURL}?view=readonly&data=${encodedData}`;
            }
            
            document.getElementById('shareContainer').innerHTML = `
                <div class="share-container">
                    <h3>üì± Send This Link to Everyone:</h3>
                    ${isGitHubConnected ? `
                        <div style="background: #d1fae5; padding: 10px; border-radius: 5px; margin-bottom: 15px; border: 1px solid #10b981;">
                            <strong>üîÑ Live Updates Enabled!</strong> This link will always show the latest data from GitHub.
                        </div>
                    ` : `
                        <div style="background: #fef3c7; padding: 10px; border-radius: 5px; margin-bottom: 15px; border: 1px solid #f59e0b;">
                            <strong>üì∏ Snapshot Link:</strong> This link contains current data only. Set up GitHub sync for live updates.
                        </div>
                    `}
                    <div class="share-link">
                        <input type="text" value="${shareLink}" readonly style="font-size: 14px;">
                        <button onclick="copyToClipboard('${shareLink}')">Copy Link</button>
                    </div>
                    
                    <h4 style="margin-top: 20px;">Sample Group Text:</h4>
                    <div style="background: white; padding: 15px; border-radius: 8px; font-style: italic; margin: 10px 0;">
                        "Hey everyone! üéâ Here's the link for my bachelor party details and payment tracking. Click the link, select your name, and you'll see what you owe plus all the event info: ${shareLink}"
                    </div>
                    <button onclick="copyToClipboard('Hey everyone! üéâ Here\\'s the link for my bachelor party details and payment tracking. Click the link, select your name, and you\\'ll see what you owe plus all the event info: ${shareLink}')">Copy Sample Text</button>
                </div>
            `;
            document.getElementById('shareContainer').style.display = 'block';
        }

        function copyToClipboard(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    alert('Copied to clipboard!');
                });
            } else {
                // Fallback
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('Copied to clipboard!');
            }
        }

        function updateTables() {
            updateAttendeesTable();
            updateActivitiesTable();
            updatePaymentTracking();
            updateStats();
        }

        function updateAttendeesTable() {
            const tbody = document.getElementById('attendeesBody');
            if (attendees.length === 0) {
                tbody.innerHTML = '<tr class="empty-state"><td colspan="2">No attendees added yet</td></tr>';
                return;
            }
            
            tbody.innerHTML = attendees.map((attendee, index) => `
                <tr>
                    <td>${attendee.name}</td>
                    <td>
                        <button class="action-btn delete-btn" onclick="deleteAttendee(${index})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function updateActivitiesTable() {
            const tbody = document.getElementById('activitiesBody');
            if (activities.length === 0) {
                tbody.innerHTML = '<tr class="empty-state"><td colspan="6">No activities planned yet</td></tr>';
                return;
            }
            
            tbody.innerHTML = activities.map((activity, index) => {
                const startDate = activity.startDate ? new Date(activity.startDate) : null;
                const endDate = activity.endDate ? new Date(activity.endDate) : null;
                const startStr = startDate ? `${startDate.toLocaleDateString()} ${startDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}` : 'TBD';
                const endStr = endDate ? `${endDate.toLocaleDateString()} ${endDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}` : 'TBD';
                
                return `
                    <tr>
                        <td>${activity.name}</td>
                        <td>${startStr}</td>
                        <td>${endStr}</td>
                        <td>${activity.location || 'TBD'}</td>
                        <td>$${activity.cost.toFixed(2)}</td>
                        <td>
                            <button class="action-btn delete-btn" onclick="deleteActivity(${index})">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updatePaymentTracking() {
            const container = document.getElementById('paymentContainer');
            
            if (activities.filter(a => a.cost > 0).length === 0 || attendees.length === 0) {
                container.innerHTML = '<p class="empty-state">Add attendees and activities with costs to track payments</p>';
                return;
            }
            
            let html = '<div class="table-container"><table><thead><tr><th>Attendee</th>';
            
            activities.forEach(activity => {
                if (activity.cost > 0) {
                    html += `<th>${activity.name}<br><small>$${activity.cost.toFixed(2)}</small></th>`;
                }
            });
            
            html += '<th>Total Owed</th></tr></thead><tbody>';
            
            attendees.forEach((attendee, attIdx) => {
                let totalOwed = 0;
                html += `<tr><td><strong>${attendee.name}</strong></td>`;
                
                activities.forEach((activity, actIdx) => {
                    if (activity.cost > 0) {
                        const key = `${attIdx}_${actIdx}`;
                        const isPaid = payments[key];
                        
                        if (!isPaid) totalOwed += activity.cost;
                        
                        html += `<td style="text-align: center;">
                            <input type="checkbox" 
                                class="payment-checkbox" 
                                ${isPaid ? 'checked' : ''} 
                                onchange="togglePayment(${attIdx}, ${actIdx})">
                            <br><small>${isPaid ? '‚úÖ Paid' : '‚è≥ Pending'}</small>
                        </td>`;
                    }
                });
                
                html += `<td style="text-align: center; font-weight: bold; color: ${totalOwed > 0 ? '#f59e0b' : '#10b981'};">
                    $${totalOwed.toFixed(2)}
                </td></tr>`;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function updateStats() {
            document.getElementById('totalAttendees').textContent = attendees.length;
            document.getElementById('totalActivities').textContent = activities.length;
            
            const totalCost = activities.reduce((sum, activity) => sum + activity.cost, 0);
            document.getElementById('totalCost').textContent = `$${totalCost.toFixed(2)}`;
        }

        function loadLocalData() {
            const savedAttendees = localStorage.getItem('bachelorPartyAttendees');
            const savedActivities = localStorage.getItem('bachelorPartyActivities');
            const savedPayments = localStorage.getItem('bachelorPartyPayments');
            
            if (savedAttendees) attendees = JSON.parse(savedAttendees);
            if (savedActivities) activities = JSON.parse(savedActivities);
            if (savedPayments) payments = JSON.parse(savedPayments);
            
            updateTables();
        }

        function saveData() {
            // Save to localStorage as backup
            localStorage.setItem('bachelorPartyAttendees', JSON.stringify(attendees));
            localStorage.setItem('bachelorPartyActivities', JSON.stringify(activities));
            localStorage.setItem('bachelorPartyPayments', JSON.stringify(payments));
            
            // Save to GitHub if connected
            if (isGitHubConnected) {
                saveToGitHub();
            }
        }
    </script>
</body>
</html>
